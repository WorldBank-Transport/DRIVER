---
- name: Create service account for application
  user: name={{ app_username }}
        system=yes
        home=/var/lib/{{ app_username }}
        shell=/bin/false
        state=present

- name: Create configuration file directory
  file: path={{ root_conf_dir }}
        owner={{ app_username }}
        group={{ app_username }}
        mode=0750
        state=directory

- name: Configure application
  copy: content={{ item.value }}
        dest={{ root_conf_dir }}/{{ item.key }}
        owner=root
        group={{ app_username }}
        mode=0750
  with_dict: envdir_conf
  notify:
    - Restart driver-app

- name: Create static files directory
  file: path={{ root_static_dir }}
        owner={{ app_username }}
        group={{ app_username }}
        mode=0775
        state=directory

- name: Create media files directory
  file: path={{ root_media_dir }}
        owner={{ app_username }}
        group={{ app_username }}
        mode=0775
        state=directory

- name: Configure Driver application service definition
  template: src=upstart-default.j2 dest=/etc/init/driver-app.conf
  notify:
    - Restart driver-app

- name: Configure Driver application Nginx service definition
  template: src=nginx-default.j2 dest=/etc/nginx/conf.d/driver-app.conf
  notify:
    - Restart Nginx

#- name: Run django collectstatic
  #django_manage: command=collectstatic app_path={{ root_app_dir }}

#- name: Run django migrations
  #django_manage: command=migrate app_path={{ root_app_dir }}

#- name: Add OAuth2 default application (development only)
  #django_manage: command="create_oauth_app admin" app_path={{ root_app_dir }}
  #when: developing_or_testing
